{% extends 'base.html' %}

{% block head %}
<!--link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}"-->
{% endblock head %}

{% block content %}

<h2>Profile</h2>
<form id="profile-form" method="POST" action="{{ url_for('profile.profile') }}" autocomplete="off">
    {{ form.hidden_tag() }}
    <label for="name">Name:</label>
    <input type="text" id="name" name="name" value="{{ user.name }}" autocomplete="off" required>
        
    <label for="email">Email:</label>
    <input type="email" id="email" name="email" value="{{ user.email }}" autocomplete="off" required>

    <label for="phone">Phone:</label>
    <input type="text" id="phone" name="phone" value="{{ user.phone }}" autocomplete="off" required>

    <button type="submit">Update Profile</button>
</form>

<h2>Change Password</h2>
<form id="password-form" method="POST" action="{{ url_for('profile.change_password') }}" autocomplete="off">
    {{ form.hidden_tag() }}
    <label for="current_password">Current Password:</label>
    <input type="password" id="current_password" name="current_password" autocomplete="off" required>

    <label for="new_password">New Password:</label>
    <input type="password" id="new_password" name="new_password" autocomplete="off" required>

    <label for="confirm_password">Confirm New Password:</label>
    <input type="password" id="confirm_password" name="confirm_password" autocomplete="off" required>

    <button type="submit">Change Password</button>
</form>

<!-- JavaScript to handle the forms via AJAX -->
<script>
    function getCSRFToken() {
        return document.getElementById('csrf_token').value;
    }
    document.getElementById('profile-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent the default form submission

        const formData = new FormData(this);

        fetch('{{ url_for("profile.profile") }}', {
            method: 'POST',
            body: formData,
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message); // Show success message
            } else {
                alert(data.message); // Show error message
            }
        }).catch(error => console.error('Error:', error));
    });

    document.getElementById('password-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent the default form submission

        const formData = new FormData(this);

        fetch('{{ url_for("profile.change_password") }}', {
            method: 'POST',
            body: formData,
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message); // Show success message
            } else {
                alert(data.message); // Show error message
            }
        }).catch(error => console.error('Error:', error));
    });

    document.getElementById('profile-picture-input').addEventListener('change', function(event) {
        event.preventDefault();

        const fileInput = event.target;
        const formData = new FormData();
        formData.append('profile_picture', fileInput.files[0]);
        const csrfToken = getCSRFToken()

        fetch('{{ url_for("profile.upload_profile_picture") }}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken // Include the CSRF token in the headers
            },
            body: formData,
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message); // Show success message
                // Optionally, update the profile picture on the page
            } else {
                alert(data.message); // Show error message
            }
        }).catch(error => console.error('Error:', error));
    });
</script>
{% endblock content %}
